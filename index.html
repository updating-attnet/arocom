<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Acquisition Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8 font-inter flex justify-center items-start">

    <div id="appContainer" class="w-full flex justify-center items-start">
    </div>

    <div id="appModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeModalButton">&times;</span>
            <h2 id="modalTitle" class="text-xl font-bold mb-4 text-gray-800"></h2>
            <p id="modalMessage" class="text-gray-700"></p>
            <p id="modalSubMessage" class="text-sm text-gray-500 mt-2"></p>
        </div>
    </div>

    <script type="module">
        const { createClient } = window.supabase;

        const SUPABASE_URL = 'https://icnwrapjvqakjwsgvbsu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImljbndyYXBqdnFha2p3c2d2YnN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMDE5NzgsImV4cCI6MjA2Njc3Nzk3OH0.vCeAmBdOZZsph78csQ2EePyYvEETVxMt68VHxe_Bbr0';

        let supabase;
        let userId;

        const ADMIN_EMAIL = "admin@aro.co";
        const ADMIN_PASSWORD = "ArocomRash";

        // Product data extracted from the provided image
        const PRODUCTS = [
            { id: 'HTR-134MBS', category: 'Refrigerator', name: '1 DOOR DCOOL HR-134MBS R6 SLV', cashPrice: 206064, installment18Months: 298793, monthlyRepayment: 16600 },
            { id: 'HTR-185CS', category: 'Refrigerator', name: '1 DOOR DCOOL HR-185CS R6 SLV', cashPrice: 355418, installment18Months: 515356, monthlyRepayment: 28631 },
            { id: 'HTR-80BEX', category: 'Refrigerator', name: '2 DOOR DCOOL 80BEX R6 SLV', cashPrice: 265424, installment18Months: 384865, monthlyRepayment: 21381 },
            { id: 'HTR-160BEX', category: 'Refrigerator', name: 'T MOUNT DD HRF-160 BEX R6 SLV', cashPrice: 354358, installment18Months: 513820, monthlyRepayment: 28546 },
            { id: 'HTR-250BLUX', category: 'Refrigerator', name: 'T MOUNT DD HRF-250 BLUX R6 SLV', cashPrice: 516220, installment18Months: 748519, monthlyRepayment: 41584 },
            { id: 'HTR-355BLUX', category: 'Refrigerator', name: 'T MOUNT DD HRF-355 BLUX R6 SLV', cashPrice: 674054, installment18Months: 977378, monthlyRepayment: 54299 },

            { id: 'HTF-150HAS', category: 'Freezer', name: 'CHEST SML HTF-150HAS R6 SLV', cashPrice: 351602, installment18Months: 509823, monthlyRepayment: 28324 },
            { id: 'HTF-200R6WHT', category: 'Freezer', name: 'CHEST SML HTF-200 R6 WHT', cashPrice: 372378, installment18Months: 539948, monthlyRepayment: 29997 },
            { id: 'HTF-200HAS', category: 'Freezer', name: 'CHEST SML HTF-200HAS R6 SLV', cashPrice: 396546, installment18Months: 574992, monthlyRepayment: 31944 },
            { id: 'HTF-719HB', category: 'Freezer', name: 'CHEST LRG HTF-719HB R290 WHT', cashPrice: 1301362, installment18Months: 1886975, monthlyRepayment: 104832 },
            { id: 'HTF-219IW', category: 'Freezer', name: 'CHEST MED HTF-219IW R6 WHT', cashPrice: 473078, installment18Months: 685963, monthlyRepayment: 38109 },
            { id: 'HTF-219IS', category: 'Freezer', name: 'CHEST MED HTF-219IS R6 SLV', cashPrice: 489296, installment18Months: 709479, monthlyRepayment: 39416 },
            { id: 'HTF-319IW', category: 'Freezer', name: 'CHEST MED HTF-319IW R6 WHT', cashPrice: 605790, installment18Months: 878396, monthlyRepayment: 48800 },
            { id: 'HTF-219TS', category: 'Freezer', name: 'CHEST MED HTF-219TS R6 SLV', cashPrice: 591268, installment18Months: 857339, monthlyRepayment: 47630 },
            { id: 'HTF-319TS', category: 'Freezer', name: 'CHEST MED HTF-319TS R6 SLV', cashPrice: 732990, installment18Months: 1062835, monthlyRepayment: 59046 },
            { id: 'HTF-429IS', category: 'Freezer', name: 'CHEST MED HTF-429IS R6 SLV', cashPrice: 999262, installment18Months: 1448930, monthlyRepayment: 80496 },

            { id: 'TG-JUR1500MS', category: 'Generator', name: 'TEC GEN PTR SML JUR 1500MS 1.25KVA/1.0KW', cashPrice: 76320, installment18Months: 110664, monthlyRepayment: 6148 },
            { id: 'TG-BOBO2800MS', category: 'Generator', name: 'TEC GEN PTR SML BOBO 2800MS 2.5KVA/2.0KW', cashPrice: 370046, installment18Months: 536567, monthlyRepayment: 29809 },
            { id: 'TG-BOBO2800ES', category: 'Generator', name: 'TEC GEN PTR SML BOBO 2800ES 2.5KVA/2.0KW', cashPrice: 444776, installment18Months: 644926, monthlyRepayment: 35829 },
            { id: 'TG-HSTL4000ES', category: 'Generator', name: 'TEC GEN PTR MED HSTL 4000ES 3.75KVA/3.0KW', cashPrice: 475940, installment18Months: 690113, monthlyRepayment: 38340 },
            { id: 'TG-OPT2800ES', category: 'Generator', name: 'TEC GEN PTR SML OPT 2800ES 2.5KVA/2.0KW', cashPrice: 461842, installment18Months: 669671, monthlyRepayment: 37204 },
            { id: 'TG-OGA7500ES', category: 'Generator', name: 'TEC GEN PTR LRG OGA7500ES 6.25KVA/5.0KW', cashPrice: 907360, installment18Months: 1315672, monthlyRepayment: 73093 },
            { id: 'TG-JNR1500MS', category: 'Generator', name: 'TEC GEN PTR SML JNR 1500MS 1.25KVA/1.0KW', cashPrice: 246450, installment18Months: 357353, monthlyRepayment: 19853 }
        ];

        let appState = {
            currentView: 'loading',
            loggedInUser: null,
            isAdmin: false,
            formData: {
                name: '',
                mobileNumbers: '',
                officeAPNumber: '',
                ippisNumber: '',
                employmentCode: '',
                rank: '',
                presentServicePoint: '',
                tiePoint: '',
                dateOfEnrolment: '',
                serviceTerminalDate: '',
                presentMonthlySalary: '',
                previousFinancialCommitments: '',
                netMonthlySalary: '',
                productSelections: [{ productId: '', details: '', estimatedMonthlyPayment: 0, monthlyPayment: 0 }],
                totalCostOfAssets: '',
                monthlyRepayment: '',
                status: 'pending',
                applicantUid: '',
                submissionDate: '',
                applicantSignature: '',
                applicationDate: '',
                passportPhotoUrl: ''
            },
            applications: []
        };

        // Function to display a modal message
        function showModal(title, message, subMessage = '') {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalSubMessage').textContent = subMessage;
            document.getElementById('appModal').style.display = 'flex';
        }

        // Function to hide the modal message
        function hideModal() {
            document.getElementById('appModal').style.display = 'none';
        }

        // Initialize Supabase client and set up authentication listener
        async function initializeSupabase() {
            try {
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                supabase.auth.onAuthStateChange(async (event, session) => {
                    if (session) {
                        appState.loggedInUser = session.user;
                        userId = session.user.id;
                        appState.isAdmin = (session.user.email === ADMIN_EMAIL);
                        console.log("User authenticated:", session.user.email, "Is Admin:", appState.isAdmin);

                        if (appState.isAdmin) {
                            appState.currentView = 'adminDashboard';
                            await fetchApplications();
                        } else {
                            appState.currentView = 'applicantForm';
                            await loadApplicantFormData();
                        }
                    } else {
                        appState.loggedInUser = null;
                        appState.isAdmin = false;
                        appState.currentView = 'login';
                        userId = null;
                    }
                    renderApp();
                });

                // Check for existing session on load
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    appState.currentView = 'login';
                    renderApp();
                }

            } catch (error) {
                console.error("Error initializing Supabase:", error);
                showModal('Error', 'Failed to initialize application. Please try again later.', error.message);
                appState.currentView = 'error';
                renderApp();
            }
        }

        // Renders the main application view based on appState.currentView
        function renderApp() {
            const container = document.getElementById('appContainer');
            container.innerHTML = '';

            let contentHtml = '';

            switch (appState.currentView) {
                case 'loading':
                    contentHtml = `
                        <div class="flex flex-col items-center justify-center min-h-screen">
                            <div class="loader"></div>
                            <p class="mt-4 text-lg text-gray-700">Loading application...</p>
                        </div>
                    `;
                    break;
                case 'login':
                case 'signup':
                    contentHtml = renderAuthForm();
                    break;
                case 'applicantForm':
                    contentHtml = renderApplicantForm();
                    break;
                case 'adminDashboard':
                    contentHtml = renderAdminDashboard();
                    break;
                case 'adminLogin':
                    contentHtml = renderAdminLoginForm();
                    break;
                case 'error':
                    contentHtml = `
                        <div class="flex flex-col items-center justify-center min-h-screen text-red-600">
                            <h2 class="text-2xl font-bold">Application Error</h2>
                            <p class="mt-2">Something went wrong. Please refresh the page.</p>
                        </div>
                    `;
                    break;
            }

            container.innerHTML = contentHtml;
            attachEventListenersForCurrentView();
        }

        // Attaches event listeners relevant to the current view
        function attachEventListenersForCurrentView() {
            switch (appState.currentView) {
                case 'login':
                case 'signup':
                    setupAuthFormListeners();
                    break;
                case 'applicantForm':
                    setupApplicantFormListeners();
                    break;
                case 'adminDashboard':
                    setupAdminDashboardListeners();
                    break;
                case 'adminLogin':
                    setupAdminLoginFormListeners();
                    break;
            }
        }

        // Sets up event listeners for the authentication form (login/signup)
        function setupAuthFormListeners() {
            const authForm = document.getElementById('authForm');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const toggleAuthViewButton = document.getElementById('toggleAuthView');
            const goToAdminLoginButton = document.getElementById('goToAdminLogin');

            if (authForm) {
                authForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = emailInput.value;
                    const password = passwordInput.value;

                    try {
                        if (appState.currentView === 'login') {
                            const { error } = await supabase.auth.signInWithPassword({ email, password });
                            if (error) throw error;
                            showModal('Success', 'Logged in successfully!', 'Redirecting to your application form.');
                        } else {
                            const { error } = await supabase.auth.signUp({ email, password });
                            if (error) throw error;
                            showModal('Success', 'Account created successfully!', 'Please check your email to confirm your account, then log in.');
                        }
                    } catch (error) {
                        console.error("Authentication error:", error);
                        showModal('Authentication Failed', 'Please check your email and password.', error.message);
                    }
                });
            }

            if (toggleAuthViewButton) {
                toggleAuthViewButton.addEventListener('click', () => {
                    appState.currentView = appState.currentView === 'login' ? 'signup' : 'login';
                    renderApp();
                });
            }

            if (goToAdminLoginButton) {
                goToAdminLoginButton.addEventListener('click', () => {
                    appState.currentView = 'adminLogin';
                    renderApp();
                });
            }
        }

        // Sets up event listeners for the admin login form
        function setupAdminLoginFormListeners() {
            const adminLoginForm = document.getElementById('adminLoginForm');
            const adminEmailInput = document.getElementById('adminEmail');
            const adminPasswordInput = document.getElementById('adminPassword');
            const goToApplicantLoginButton = document.getElementById('goToApplicantLogin');

            if (adminLoginForm) {
                adminLoginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = adminEmailInput.value;
                    const password = adminPasswordInput.value;

                    if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                        try {
                            const { error } = await supabase.auth.signInWithPassword({ email, password });
                            if (error) throw error;
                            showModal('Success', 'Admin Login Successful!', 'Redirecting to admin dashboard.');
                        } catch (error) {
                            console.error("Admin login error:", error);
                            showModal('Login Failed', 'Could not log in as admin. Please check credentials.', error.message);
                        }
                    } else {
                        showModal('Login Failed', 'Invalid admin credentials.');
                    }
                });
            }

            if (goToApplicantLoginButton) {
                goToApplicantLoginButton.addEventListener('click', () => {
                    appState.currentView = 'login';
                    renderApp();
                });
            }
        }

        // Sets up event listeners for the applicant form
        function setupApplicantFormListeners() {
            const interestForm = document.getElementById('interestForm');
            const signOutButton = document.getElementById('signOutButton');
            const addProductButton = document.getElementById('addProductButton');
            const passportPhotoInput = document.getElementById('passportPhotoInput');


            if (interestForm) {
                // Add event listeners for general form fields
                const formElements = interestForm.querySelectorAll('input:not([data-field]), textarea');
                formElements.forEach(element => {
                    element.addEventListener('input', handleChange);
                });

                interestForm.addEventListener('submit', handleSubmit);
            }

            if (signOutButton) {
                signOutButton.addEventListener('click', signOutUser);
            }

            if (addProductButton) {
                addProductButton.addEventListener('click', addProductSelectionRow);
            }

            if (passportPhotoInput) {
                passportPhotoInput.addEventListener('change', handlePassportPhotoUpload);
            }

            renderProductDetails();
            updateTotal();
            // Ensure the name declaration is updated on load
            const applicantNameDeclaration = document.getElementById('applicantNameDeclaration');
            if (applicantNameDeclaration) {
                applicantNameDeclaration.textContent = appState.formData.name || '';
            }
        }

        // Sets up event listeners for the admin dashboard
        function setupAdminDashboardListeners() {
            const signOutButton = document.getElementById('signOutButton');

            if (signOutButton) {
                signOutButton.addEventListener('click', signOutUser);
            }

            renderApplications();
        }

        // Renders the authentication form (login or signup)
        function renderAuthForm() {
            const isLogin = appState.currentView === 'login';
            return `
                <div class="bg-white shadow-lg rounded-lg p-6 sm:p-8 max-w-md w-full my-8 border border-gray-200">
                    <h2 class="text-2xl font-bold text-center text-blue-700 mb-6">
                        ${isLogin ? 'Applicant Login' : 'Applicant Signup'}
                    </h2>
                    <form id="authForm" class="space-y-4">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                            <input type="email" id="email" name="email" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password:</label>
                            <input type="password" id="password" name="password" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                        </div>
                        <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300">
                            ${isLogin ? 'Login' : 'Signup'}
                        </button>
                    </form>
                    <div class="mt-4 text-center">
                        <button id="toggleAuthView" class="text-blue-600 hover:underline text-sm">
                            ${isLogin ? 'Need an account? Sign Up' : 'Already have an account? Login'}
                        </button>
                        <button id="goToAdminLogin" class="block mt-2 text-blue-600 hover:underline text-sm mx-auto">
                            Admin Login
                        </button>
                    </div>
                </div>
            `;
        }

        // Renders the admin login form
        function renderAdminLoginForm() {
            return `
                <div class="bg-white shadow-lg rounded-lg p-6 sm:p-8 max-w-md w-full my-8 border border-gray-200">
                    <h2 class="text-2xl font-bold text-center text-blue-700 mb-6">Admin Login</h2>
                    <form id="adminLoginForm" class="space-y-4">
                        <div>
                            <label for="adminEmail" class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                            <input type="email" id="adminEmail" name="adminEmail" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                        </div>
                        <div>
                            <label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-1">Password:</label>
                            <input type="password" id="adminPassword" name="adminPassword" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" required />
                        </div>
                        <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300">
                            Login as Admin
                        </button>
                    </form>
                    <div class="mt-4 text-center">
                        <button id="goToApplicantLogin" class="text-blue-600 hover:underline text-sm">
                            Applicant Login
                        </button>
                    </div>
                </div>
            `;
        }

        // Renders the applicant interest form
        function renderApplicantForm() {
            const passportPhotoSrc = appState.formData.passportPhotoUrl || 'https://placehold.co/150x150/e0e0e0/555555?text=Passport+Photo';
            return `
                <div class="bg-white shadow-lg rounded-lg p-6 sm:p-8 lg:p-10 max-w-4xl w-full my-8 border border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h1 class="text-xl sm:text-2xl font-bold text-gray-800 uppercase">AROCOM GLOBAL MERCHANDISE LIMITED</h1>
                        <button id="signOutButton" class="px-4 py-2 bg-red-600 text-white text-sm font-semibold rounded-md hover:bg-red-700">Sign Out</button>
                    </div>
                    <p class="text-md sm:text-lg text-gray-600 mb-2">ASSET ACQUISITION SCHEME FOR POLICE OFFICERS</p>
                    <h2 class="text-2xl sm:text-3xl font-extrabold text-blue-700 mt-6 mb-4 text-center">EXPRESSION OF INTEREST FORM</h2>

                    <form id="interestForm" class="space-y-8">
                        <div class="border border-gray-300 rounded-lg p-4 sm:p-6">
                            <h3 class="text-lg sm:text-xl font-semibold text-gray-700 mb-4">PART A: PERSONAL INFORMATION</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                                <div class="flex flex-col items-center justify-center border border-dashed border-gray-400 rounded-md p-4 h-40 sm:h-48 bg-gray-50 text-gray-500 relative overflow-hidden">
                                    <img id="passportPhotoPreview" src="${passportPhotoSrc}" alt="Passport Photo Preview" class="absolute inset-0 w-full h-full object-cover ${appState.formData.passportPhotoUrl ? '' : 'opacity-50'}" onerror="this.src='https://placehold.co/150x150/e0e0e0/555555?text=Passport+Photo';" />
                                    <p class="text-sm text-center z-10 ${appState.formData.passportPhotoUrl ? 'hidden' : ''}">Affix your most recent passport photograph here</p>
                                    <div class="mt-2 text-xs z-10 ${appState.formData.passportPhotoUrl ? 'hidden' : ''}">(Click to upload)</div>
                                    <input type="file" id="passportPhotoInput" class="opacity-0 absolute inset-0 w-full h-full cursor-pointer z-20" accept="image/*" />
                                </div>

                                <div class="grid grid-cols-1 gap-3">
                                    <div class="flex flex-col">
                                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name:</label>
                                        <input type="text" id="name" name="name" class="p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" required />
                                    </div>
                                    <div class="flex flex-col">
                                        <label for="mobileNumbers" class="block text-sm font-medium text-gray-700 mb-1">Mobile Number(s):</label>
                                        <input type="text" id="mobileNumbers" name="mobileNumbers" class="p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" required />
                                    </div>
                                    <div class="flex flex-col">
                                        <label for="officeAPNumber" class="block text-sm font-medium text-gray-700 mb-1">Office/AP Number:</label>
                                        <input type="text" id="officeAPNumber" name="officeAPNumber" class="p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" required />
                                    </div>
                                    <div class="flex flex-col">
                                        <label for="ippisNumber" class="block text-sm font-medium text-gray-700 mb-1">IPPIS Number:</label>
                                        <input type="text" id="ippisNumber" name="ippisNumber" class="p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" required />
                                    </div>
                                    <div class="flex flex-col">
                                        <label for="employmentCode" class="block text-sm font-medium text-gray-700 mb-1">Employment Code:</label>
                                        <input type="text" id="employmentCode" name="employmentCode" class="p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" required />
                                    </div>
                                    <div class="flex flex-col">
                                        <label for="rank" class="block text-sm font-medium text-gray-700 mb-1">Rank:</label>
                                        <input type="text" id="rank" name="rank" class="p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" required />
                                    </div>
                                </div>

                                <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6 mt-4">
                                    <div class="flex flex-col">
                                        <label for="presentServicePoint" class="block text-sm font-medium text-gray-700 mb-1">Present Service Point:</label>
                                        <input type="text" id="presentServicePoint" name="presentServicePoint" class="p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" required />
                                    </div>
                                    <div class="flex flex-col">
                                        <label for="tiePoint" class="block text-sm font-medium text-gray-700 mb-1">Tie Point:</label>
                                        <input type="text" id="tiePoint" name="tiePoint" class="p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" required />
                                    </div>
                                    <div class="flex flex-col">
                                        <label for="dateOfEnrolment" class="block text-sm font-medium text-gray-700 mb-1">Date of Enrolment:</label>
                                        <input type="date" id="dateOfEnrolment" name="dateOfEnrolment" class="p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" required />
                                    </div>
                                    <div class="flex flex-col">
                                        <label for="serviceTerminalDate" class="block text-sm font-medium text-gray-700 mb-1">Service Terminal Date:</label>
                                        <input type="date" id="serviceTerminalDate" name="serviceTerminalDate" class="p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" required />
                                    </div>
                                </div>

                                <div class="md:col-span-2 space-y-4 mt-4">
                                    <div class="flex flex-col">
                                        <label for="presentMonthlySalary" class="block text-sm font-medium text-gray-700 mb-1">Present Monthly Salary:</label>
                                        <input type="number" id="presentMonthlySalary" name="presentMonthlySalary" class="p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" required />
                                    </div>
                                    <div class="flex flex-col">
                                        <label for="previousFinancialCommitments" class="block text-sm font-medium text-gray-700 mb-1">State details of previous financial commitment(s) and credit facility(s) obtained that you are still paying:</label>
                                        <textarea id="previousFinancialCommitments" name="previousFinancialCommitments" rows="3" class="p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Car loan, house mortgage, etc."></textarea>
                                    </div>
                                    <div class="flex flex-col">
                                        <label for="netMonthlySalary" class="block text-sm font-medium text-gray-700 mb-1">Net monthly salary:</label>
                                        <input type="number" id="netMonthlySalary" name="netMonthlySalary" class="p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" required />
                                    </div>
                                    <p class="text-xs text-gray-500 italic">
                                        (Note role that you cannot acquire asset(s) that the monthly repayment will be more than one-third of your net monthly salary)
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="border border-gray-300 rounded-lg p-4 sm:p-6">
                            <h3 class="text-lg sm:text-xl font-semibold text-gray-700 mb-4">PART B: PRODUCT DETAILS</h3>
                            <p class="text-sm text-gray-600 mb-4">
                                State details including type(s) and brand(s) of the asset(s) demanded with the eighteen (18) months installment price(s) and the amount of monthly repayment as stated in the price lists.
                                <br />
                                <span class="italic">(Ensure you check our price lists carefully in the process of filling your request)</span>
                            </p>

                            <div class="overflow-x-auto mb-6">
                                <table class="min-w-full bg-white border border-gray-200 rounded-md">
                                    <thead>
                                        <tr class="bg-gray-100 text-gray-700 text-left text-sm">
                                            <th class="py-2 px-3 border-b border-gray-200">S/N</th>
                                            <th class="py-2 px-3 border-b border-gray-200">DETAILS OF PRODUCT(S)</th>
                                            <th class="py-2 px-3 border-b border-gray-200">ESTIMATED MONTHLY PAYMENT (N)</th>
                                            <th class="py-2 px-3 border-b border-gray-200">MONTHLY PAYMENT (N)</th>
                                            <th class="py-2 px-3 border-b border-gray-200">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productDetailsTableBody">
                                        <!-- Product rows will be rendered here by JavaScript -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="bg-gray-50">
                                            <td colspan="2" class="py-2 px-3 text-right font-semibold text-gray-700 text-sm">TOTAL (N)</td>
                                            <td colspan="3" class="py-2 px-3 border-t border-gray-200">
                                                <input type="number" id="totalMonthlyPayment" class="w-full p-1 border border-gray-300 rounded-md text-sm font-semibold focus:ring-blue-500 focus:border-blue-500" placeholder="Total" readonly />
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                                <button type="button" id="addProductButton" class="mt-4 px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300">
                                    Add Product
                                </button>
                            </div>

                            <div class="space-y-4">
                                <div class="flex flex-col">
                                    <label for="totalCostOfAssets" class="block text-sm font-medium text-gray-700 mb-1">Total cost of asset(s) demanded: (Amount in words)</label>
                                    <input type="text" id="totalCostOfAssets" name="totalCostOfAssets" class="p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" required />
                                </div>
                                <div class="flex flex-col">
                                    <label for="monthlyRepayment" class="block text-sm font-medium text-gray-700 mb-1">Monthly Repayment: (Amount in words)</label>
                                    <input type="text" id="monthlyRepayment" name="monthlyRepayment" class="p-2 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500" required />
                                </div>
                            </div>
                        </div>

                        <div class="border border-gray-300 rounded-lg p-4 sm:p-6">
                            <h3 class="text-lg sm:text-xl font-semibold text-gray-700 mb-4">PART C: DECLARATION BY APPLICANT</h3>
                            <p class="text-sm text-gray-700 mb-4 leading-relaxed">
                                I, <span class="inline-block border-b border-gray-400 w-40" id="applicantNameDeclaration"></span> hereby declare that the information given above are true and very correct to the best of my knowledge and understanding.
                            </p>
                            <p class="text-sm text-gray-700 mb-4 leading-relaxed">
                                I wish to confirm my readiness to collect the afore-stated asset(s) at the above quoted price(s) on delivery and humbly mandate the Officers in-charge of payment of my salaries (Mechanized Salary Section) to effect monthly deduction of the above sum for eighteen (18) months period of the facility and pay <span class="font-bold">AROCOM GLOBAL MERCHANDISE LIMITED</span> or its designated bank account on the day of paying my salary.
                            </p>
                            <p class="text-sm text-gray-700 mb-4 leading-relaxed">
                                I wish to state further that in-case of an unforeseen circumstances in the course of deduction of the monthly repayment from my salary before the terminal period of the facility, the balance of the facility would be charged to my next of kin/estate.
                            </p>
                            <p class="text-sm text-gray-700 mb-6 leading-relaxed">
                                I hereby state that the afore-stated instructions are given by me irrevocably and without the right of set-off of the instruction after collecting the asset(s) demanded.
                            </p>

                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mt-6 space-y-4 sm:space-y-0">
                                <div class="flex-1 mr-0 sm:mr-4 w-full">
                                    <label for="applicantSignature" class="block text-sm font-medium text-gray-700 mb-1">Applicant's Signature:</label>
                                    <input type="text" id="applicantSignature" name="applicantSignature" class="w-full p-2 border-b-2 border-gray-400 focus:border-blue-500 focus:outline-none text-sm" placeholder="Digital Signature Area" required />
                                </div>
                                <div class="flex-1 w-full">
                                    <label for="applicationDate" class="block text-sm font-medium text-gray-700 mb-1">Date:</label>
                                    <input type="date" id="applicationDate" name="applicationDate" class="w-full p-2 border-b-2 border-gray-400 focus:border-blue-500 focus:outline-none text-sm" required />
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-8">
                            <button type="submit" class="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out">
                                Submit Application
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        // Renders the admin dashboard
        function renderAdminDashboard() {
            return `
                <div class="bg-white shadow-lg rounded-lg p-6 sm:p-8 lg:p-10 max-w-4xl w-full my-8 border border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl sm:text-3xl font-extrabold text-blue-700">Admin Dashboard</h2>
                        <button id="signOutButton" class="px-4 py-2 bg-red-600 text-white text-sm font-semibold rounded-md hover:bg-red-700">Sign Out</button>
                    </div>
                    <p class="text-gray-600 mb-6">Review and manage submitted applications.</p>

                    <div class="overflow-x-auto mb-6">
                        <table class="min-w-full bg-white border border-gray-200 rounded-md">
                            <thead>
                                <tr class="bg-gray-100 text-gray-700 text-left text-sm">
                                    <th class="py-2 px-3 border-b border-gray-200">Applicant Name</th>
                                    <th class="py-2 px-3 border-b border-gray-200">Submission Date</th>
                                    <th class="py-2 px-3 border-b border-gray-200">Total Cost</th>
                                    <th class="py-2 px-3 border-b border-gray-200">Status</th>
                                    <th class="py-2 px-3 border-b border-gray-200">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="applicationsTableBody">
                                <!-- Applications will be rendered here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Loads applicant form data from Supabase
        async function loadApplicantFormData() {
            if (!supabase || !userId) {
                console.error("Supabase or User ID not available. Cannot load data.");
                return;
            }
            try {
                const { data, error } = await supabase
                    .from('applications')
                    .select('*')
                    .eq('user_id', userId)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 means "No rows found"
                    throw error;
                }

                if (data) {
                    appState.formData = {
                        name: data.name || '',
                        mobileNumbers: data.mobile_numbers || '',
                        officeAPNumber: data.office_ap_number || '',
                        ippisNumber: data.ippis_number || '',
                        employmentCode: data.employment_code || '',
                        rank: data.rank || '',
                        presentServicePoint: data.present_service_point || '',
                        tiePoint: data.tie_point || '',
                        dateOfEnrolment: data.date_of_enrolment || '',
                        serviceTerminalDate: data.service_terminal_date || '',
                        presentMonthlySalary: data.present_monthly_salary || null,
                        previousFinancialCommitments: data.previous_financial_commitments || '',
                        netMonthlySalary: data.net_monthly_salary || null,
                        // Ensure productSelections is an array and has default structure
                        productSelections: data.product_selections && Array.isArray(data.product_selections)
                            ? data.product_selections
                            : [{ productId: '', details: '', estimatedMonthlyPayment: 0, monthlyPayment: 0 }],
                        totalCostOfAssets: data.total_cost_of_assets || null,
                        monthlyRepayment: data.monthly_repayment || null,
                        status: data.status || 'pending',
                        applicantUid: data.user_id,
                        submissionDate: data.created_at ? new Date(data.created_at).toISOString() : '',
                        applicantSignature: data.applicant_signature || '',
                        applicationDate: data.application_date || '',
                        passportPhotoUrl: data.passport_photo_url || '' // Load passport photo URL
                    };
                    console.log("Form data loaded:", appState.formData);
                    updateFormFields();
                    renderProductDetails(); // Re-render product details after loading
                    updateTotal();
                } else {
                    console.log("No existing form data found for this applicant. Initializing with defaults.");
                    appState.formData = {
                        name: '', mobileNumbers: '', officeAPNumber: '', ippisNumber: '', employmentCode: '', rank: '',
                        presentServicePoint: '', tiePoint: '', dateOfEnrolment: '', serviceTerminalDate: '',
                        presentMonthlySalary: '', previousFinancialCommitments: '', netMonthlySalary: '',
                        productSelections: [{ productId: '', details: '', estimatedMonthlyPayment: 0, monthlyPayment: 0 }],
                        totalCostOfAssets: '', monthlyRepayment: '', status: 'pending', applicantUid: userId, submissionDate: '',
                        applicantSignature: '', applicationDate: '', passportPhotoUrl: ''
                    };
                    updateFormFields();
                    renderProductDetails(); // Re-render product details with defaults
                    updateTotal();
                }
            } catch (e) {
                console.error("Error loading document: ", e);
                showModal('Error', 'Failed to load your application data.', e.message);
            }
        }

        // Updates general form fields based on appState.formData
        function updateFormFields() {
            for (const key in appState.formData) {
                const element = document.getElementById(key);
                if (element) {
                    // Skip productSelections and passportPhotoUrl as they're handled by their respective render/event functions
                    if (key === 'productSelections' || key === 'passportPhotoUrl') {
                        continue;
                    }
                    element.value = appState.formData[key];
                }
            }
            // Update the applicant name in the declaration section
            const applicantNameDeclaration = document.getElementById('applicantNameDeclaration');
            if (applicantNameDeclaration) {
                applicantNameDeclaration.textContent = appState.formData.name || '';
            }
            // Update the passport photo preview
            const passportPhotoPreview = document.getElementById('passportPhotoPreview');
            if (passportPhotoPreview) {
                passportPhotoPreview.src = appState.formData.passportPhotoUrl || 'https://placehold.co/150x150/e0e0e0/555555?text=Passport+Photo';
                if (appState.formData.passportPhotoUrl) {
                    passportPhotoPreview.classList.remove('opacity-50');
                } else {
                    passportPhotoPreview.classList.add('opacity-50');
                }
                // Hide placeholder text if image is present
                const placeholderText = passportPhotoPreview.nextElementSibling; // This is the <p> tag
                const placeholderSubText = placeholderText ? placeholderText.nextElementSibling : null; // This is the <div> tag
                if (placeholderText) {
                    placeholderText.classList.toggle('hidden', !!appState.formData.passportPhotoUrl);
                }
                if (placeholderSubText) {
                    placeholderSubText.classList.toggle('hidden', !!appState.formData.passportPhotoUrl);
                }
            }
        }

        // Handles passport photo upload
        async function handlePassportPhotoUpload(e) {
            const file = e.target.files[0];
            if (!file) {
                return;
            }

            // Client-side validation: Check if the file is an image
            if (!file.type.startsWith('image/')) {
                showModal('Invalid File Type', 'Please upload an image file (e.g., JPG, PNG, GIF).');
                e.target.value = ''; // Clear the file input
                return;
            }

            if (!supabase || !userId) {
                showModal('Error', 'Authentication required to upload photo.', 'Please log in.');
                return;
            }

            console.log("Attempting to upload passport photo...");
            console.log("Current userId:", userId);
            const fileName = `${userId}_${Date.now()}_${file.name}`;
            const filePath = `passport_photos/${userId}/${fileName}`;
            console.log("Calculated filePath for upload:", filePath);


            try {
                const { data, error } = await supabase.storage
                    .from('passport-photos') // Ensure you have a bucket named 'passport-photos' in Supabase Storage
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) {
                    console.error("Supabase Storage Upload Error:", error); // Log the full error object
                    if (error.statusCode === '409') { // Conflict, file already exists
                        showModal('Upload Error', 'A file with this name already exists. Please rename your file or try again.');
                    } else {
                        throw error;
                    }
                }

                const { data: publicUrlData } = supabase.storage
                    .from('passport-photos')
                    .getPublicUrl(filePath);

                if (publicUrlData && publicUrlData.publicUrl) {
                    appState.formData.passportPhotoUrl = publicUrlData.publicUrl;
                    console.log("Passport photo uploaded successfully. Public URL:", appState.formData.passportPhotoUrl);
                    updateFormFields(); // Update the preview image
                    saveApplicantFormData(); // Save the new URL to the database
                    showModal('Success', 'Passport photo uploaded successfully!');
                } else {
                    showModal('Upload Error', 'Failed to get public URL for the uploaded photo.');
                }

            } catch (error) {
                console.error("Error during passport photo upload process:", error); // Log the full error object
                showModal('Upload Failed', 'Could not upload passport photo.', error.message);
            }
        }


        // Renders or re-renders the product details table
        function renderProductDetails() {
            const productDetailsTableBody = document.getElementById('productDetailsTableBody');
            if (!productDetailsTableBody) return;

            productDetailsTableBody.innerHTML = ''; // Clear existing rows

            // Ensure productSelections is an array
            const productSelectionsArray = Array.isArray(appState.formData.productSelections)
                ? appState.formData.productSelections
                : [];

            productSelectionsArray.forEach((selection, index) => {
                const row = productDetailsTableBody.insertRow();
                row.className = 'hover:bg-gray-50';

                // S/N Cell
                const snCell = row.insertCell();
                snCell.className = 'py-2 px-3 border-b border-gray-200 text-sm';
                snCell.textContent = index + 1;

                // Product Details (Dropdown) Cell
                const detailsCell = row.insertCell();
                detailsCell.className = 'py-2 px-3 border-b border-gray-200';
                const selectElement = document.createElement('select');
                selectElement.className = 'w-full p-1 border border-gray-300 rounded-md text-sm focus:ring-blue-500 focus:border-blue-500';
                selectElement.dataset.index = index;
                selectElement.dataset.field = 'productId';
                selectElement.addEventListener('change', handleProductSelectionChange);

                // Default "Select a product" option
                let defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select a product';
                selectElement.appendChild(defaultOption);

                // Populate dropdown with PRODUCTS
                PRODUCTS.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} (N${product.monthlyRepayment.toLocaleString()}/month)`;
                    selectElement.appendChild(option);
                });
                selectElement.value = selection.productId || ''; // Set selected value
                selectElement.required = true; // Make product selection required

                detailsCell.appendChild(selectElement);

                // Estimated Monthly Payment (Read-only) Cell
                const estimatedMonthlyPaymentCell = row.insertCell();
                estimatedMonthlyPaymentCell.className = 'py-2 px-3 border-b border-gray-200';
                const estimatedMonthlyPaymentInput = document.createElement('input');
                estimatedMonthlyPaymentInput.type = 'number';
                estimatedMonthlyPaymentInput.className = 'w-full p-1 border border-gray-300 rounded-md text-sm bg-gray-50';
                estimatedMonthlyPaymentInput.value = selection.estimatedMonthlyPayment || '';
                estimatedMonthlyPaymentInput.readOnly = true;
                estimatedMonthlyPaymentInput.tabIndex = -1; // Make it not focusable
                estimatedMonthlyPaymentCell.appendChild(estimatedMonthlyPaymentInput);

                // Monthly Payment (Read-only) Cell
                const monthlyPaymentCell = row.insertCell();
                monthlyPaymentCell.className = 'py-2 px-3 border-b border-gray-200';
                const monthlyPaymentInput = document.createElement('input');
                monthlyPaymentInput.type = 'number';
                monthlyPaymentInput.className = 'w-full p-1 border border-gray-300 rounded-md text-sm bg-gray-50';
                monthlyPaymentInput.value = selection.monthlyPayment || '';
                monthlyPaymentInput.readOnly = true;
                monthlyPaymentInput.tabIndex = -1; // Make it not focusable
                monthlyPaymentCell.appendChild(monthlyPaymentInput);

                // Actions Cell (Remove Button)
                const actionsCell = row.insertCell();
                actionsCell.className = 'py-2 px-3 border-b border-gray-200 text-center';
                const removeButton = document.createElement('button');
                removeButton.textContent = 'Remove';
                removeButton.className = 'px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-xs';
                removeButton.addEventListener('click', () => removeProductSelectionRow(index));
                actionsCell.appendChild(removeButton);
            });
        }

        // Adds a new empty product selection row to the form
        function addProductSelectionRow() {
            // Limit to 5 products
            if (appState.formData.productSelections.length < 5) {
                appState.formData.productSelections.push({ productId: '', details: '', estimatedMonthlyPayment: 0, monthlyPayment: 0 });
                renderProductDetails();
                saveApplicantFormData();
            } else {
                showModal('Limit Reached', 'You can add a maximum of 5 products.');
            }
        }

        // Handles changes in the product selection dropdown
        function handleProductSelectionChange(e) {
            const index = parseInt(e.target.dataset.index);
            const productId = e.target.value;

            const selectedProduct = PRODUCTS.find(p => p.id === productId);

            if (selectedProduct) {
                appState.formData.productSelections[index] = {
                    productId: selectedProduct.id,
                    details: selectedProduct.name,
                    estimatedMonthlyPayment: selectedProduct.installment18Months,
                    monthlyPayment: selectedProduct.monthlyRepayment
                };
            } else {
                // If no product selected (e.g., "Select a product" option)
                appState.formData.productSelections[index] = {
                    productId: '',
                    details: '',
                    estimatedMonthlyPayment: 0,
                    monthlyPayment: 0
                };
            }
            updateTotal();
            saveApplicantFormData();
            renderProductDetails(); // Re-render to update displayed values
        }

        // Removes a product selection row
        function removeProductSelectionRow(index) {
            if (appState.formData.productSelections.length > 1) { // Ensure at least one row remains
                appState.formData.productSelections.splice(index, 1);
                renderProductDetails();
                updateTotal();
                saveApplicantFormData();
            } else {
                showModal('Cannot Remove', 'You must have at least one product selection row.');
            }
        }

        // Calculates and updates the total monthly payment
        function updateTotal() {
            const totalMonthlyPaymentInput = document.getElementById('totalMonthlyPayment');
            if (!totalMonthlyPaymentInput) return;

            const total = (Array.isArray(appState.formData.productSelections) ? appState.formData.productSelections : []).reduce((sum, selection) => {
                const monthlyPayment = parseFloat(selection.monthlyPayment) || 0;
                return sum + monthlyPayment;
            }, 0);
            totalMonthlyPaymentInput.value = total.toFixed(2);
        }

        // Handles changes for general form fields (not product selections)
        function handleChange(e) {
            const { name, value } = e.target;
            appState.formData[name] = value;

            if (name === 'name') {
                const applicantNameDeclaration = document.getElementById('applicantNameDeclaration');
                if (applicantNameDeclaration) {
                    applicantNameDeclaration.textContent = value;
                }
            }
            saveApplicantFormData();
        }

        // Saves applicant form data to Supabase
        async function saveApplicantFormData() {
            if (!supabase || !userId) {
                console.error("Supabase or User ID not available. Cannot save data.");
                return;
            }
            try {
                const dataToSave = {
                    user_id: userId,
                    status: appState.formData.status,
                    name: appState.formData.name,
                    mobile_numbers: appState.formData.mobileNumbers,
                    office_ap_number: appState.formData.officeAPNumber,
                    ippis_number: appState.formData.ippisNumber,
                    employment_code: appState.formData.employmentCode,
                    rank: appState.formData.rank,
                    present_service_point: appState.formData.presentServicePoint,
                    tie_point: appState.formData.tiePoint,
                    date_of_enrolment: appState.formData.dateOfEnrolment,
                    service_terminal_date: appState.formData.serviceTerminalDate,
                    present_monthly_salary: parseFloat(appState.formData.presentMonthlySalary) || null,
                    previous_financial_commitments: appState.formData.previousFinancialCommitments,
                    net_monthly_salary: parseFloat(appState.formData.netMonthlySalary) || null,
                    // Save productSelections instead of productDetails
                    product_selections: appState.formData.productSelections,
                    total_cost_of_assets: parseFloat(appState.formData.totalCostOfAssets) || null,
                    monthly_repayment: parseFloat(appState.formData.monthlyRepayment) || null,
                    applicant_signature: appState.formData.applicantSignature,
                    application_date: appState.formData.applicationDate,
                    passport_photo_url: appState.formData.passportPhotoUrl // Save passport photo URL
                };

                const { data: updateData, error: updateError } = await supabase
                    .from('applications')
                    .update(dataToSave)
                    .eq('user_id', userId);

                if (updateError && updateError.code === 'PGRST116') { // PGRST116 means "No rows found"
                    console.log("No existing record found for user_id, attempting to insert.");
                    const { data: insertData, error: insertError } = await supabase
                        .from('applications')
                        .insert(dataToSave);
                    if (insertError) throw insertError;
                    console.log("Form data inserted successfully!");
                } else if (updateError) {
                    throw updateError;
                } else {
                    console.log("Form data updated successfully!");
                }
            } catch (e) {
                console.error("Error saving document: ", e);
                showModal('Error', 'Failed to save your application data.', e.message);
            }
        }

        // Handles form submission
        async function handleSubmit(e) {
            e.preventDefault();
            console.log('Form Data Submitted:', appState.formData);
            await saveApplicantFormData();
            showModal('Form Submitted!', 'Your application has been received. Thank you!', 'Check the browser console for the submitted form data (for demonstration purposes).');
        }

        // Fetches all applications for the admin dashboard
        async function fetchApplications() {
            if (!supabase) {
                console.error("Supabase not available. Cannot fetch applications.");
                return;
            }
            try {
                const { data, error } = await supabase
                    .from('applications')
                    .select('*');

                if (error) throw error;

                appState.applications = data;
                console.log("Applications fetched for admin:", appState.applications);
                if (appState.currentView === 'adminDashboard') {
                    renderApp(); // Re-render admin dashboard to show updated applications
                }
            } catch (error) {
                console.error("Error fetching applications:", error);
                showModal('Error', 'Failed to fetch applications.', error.message);
            }
        }

        // Renders the applications table in the admin dashboard
        function renderApplications() {
            const applicationsTableBody = document.getElementById('applicationsTableBody');
            if (!applicationsTableBody) return;

            applicationsTableBody.innerHTML = '';
            if (appState.applications.length === 0) {
                applicationsTableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">No applications found.</td></tr>';
                return;
            }

            appState.applications.forEach(app => {
                const row = applicationsTableBody.insertRow();
                row.className = 'hover:bg-gray-50';

                const nameCell = row.insertCell();
                nameCell.className = 'py-2 px-3 border-b border-gray-200 text-sm';
                nameCell.textContent = app.name || 'N/A';

                const dateCell = row.insertCell();
                dateCell.className = 'py-2 px-3 border-b border-gray-200 text-sm';
                const displayDate = app.application_date || app.created_at;
                dateCell.textContent = displayDate ? new Date(displayDate).toLocaleDateString() : 'N/A';

                const totalCostCell = row.insertCell();
                totalCostCell.className = 'py-2 px-3 border-b border-gray-200 text-sm';
                totalCostCell.textContent = app.total_cost_of_assets ? `N${app.total_cost_of_assets.toLocaleString()}` : 'N/A';

                const statusCell = row.insertCell();
                statusCell.className = 'py-2 px-3 border-b border-gray-200 text-sm';
                statusCell.innerHTML = `<span class="px-2 py-1 rounded-full text-xs font-semibold ${app.status === 'approved' ? 'bg-green-100 text-green-800' : app.status === 'declined' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">${app.status ? app.status.toUpperCase() : 'N/A'}</span>`;

                const actionsCell = row.insertCell();
                actionsCell.className = 'py-2 px-3 border-b border-gray-200 text-sm';
                if (app.status === 'pending') {
                    const approveButton = document.createElement('button');
                    approveButton.textContent = 'Approve';
                    approveButton.className = 'px-3 py-1 bg-green-500 text-white rounded-md hover:bg-green-600 text-xs mr-2';
                    approveButton.addEventListener('click', () => updateApplicationStatus(app.user_id, 'approved'));
                    actionsCell.appendChild(approveButton);

                    const declineButton = document.createElement('button');
                    declineButton.textContent = 'Decline';
                    declineButton.className = 'px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-xs';
                    declineButton.addEventListener('click', () => updateApplicationStatus(app.user_id, 'declined'));
                    actionsCell.appendChild(declineButton);
                } else {
                    actionsCell.textContent = 'No actions';
                    actionsCell.className += ' text-gray-500 italic';
                }
            });
        }

        // Updates the status of an application
        async function updateApplicationStatus(applicantUid, newStatus) {
            if (!supabase) {
                console.error("Supabase not available.");
                return;
            }
            try {
                const { data, error } = await supabase
                    .from('applications')
                    .update({ status: newStatus })
                    .eq('user_id', applicantUid);

                if (error) throw error;
                showModal('Success', `Application for ${applicantUid} ${newStatus}!`);
                await fetchApplications(); // Re-fetch applications to update dashboard
            } catch (error) {
                console.error("Error updating application status:", error);
                showModal('Error', 'Failed to update application status.', error.message);
            }
        }

        // Signs out the current user
        async function signOutUser() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                showModal('Signed Out', 'You have been successfully signed out.', 'Redirecting to login page.');
            } catch (error) {
                console.error("Error signing out:", error);
                showModal('Error', 'Failed to sign out.', error.message);
            }
        }

        // Event listener for DOM content loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Setup modal close buttons
            document.getElementById('closeModalButton').addEventListener('click', hideModal);
            document.getElementById('appModal').addEventListener('click', (e) => {
                if (e.target.id === 'appModal') {
                    hideModal();
                }
            });

            initializeSupabase();
            renderApp();
        });
    </script>
</body>
</html>
